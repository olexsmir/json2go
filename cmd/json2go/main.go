package main

import (
	"flag"
	"fmt"
	"io"
	"os"

	"olexsmir.xyz/json2go"
)

func main() {
	typeName := flag.String("type", "AutoGenerated", "a name for generated type")
	showHelp := flag.Bool("help", false, "show help")
	flag.Parse()

	if *showHelp {
		printHelp()
		os.Exit(0)
	}

	// get input
	args := flag.Args()

	stat, err := os.Stdin.Stat()
	if err != nil {
		fmt.Fprintf(os.Stderr, "Failed to get stdin stat: %v\n", err)
		os.Exit(1)
	}

	isPiped := (stat.Mode() & os.ModeCharDevice) == 0

	var input string
	switch {
	case len(args) > 0:
		input = args[0]
	case isPiped:
		data, rerr := io.ReadAll(os.Stdin)
		if rerr != nil {
			fmt.Fprintf(os.Stderr, "Failed to read piped input: %v\n", rerr)
			os.Exit(1)
		}
		input = string(data)
	default:
		printHelp()
		os.Exit(1)
	}

	transformer := json2go.NewTransformer()
	type_, err := transformer.Transform(*typeName, input)
	if err != nil {
		fmt.Fprintf(os.Stderr, "Failed to transform json to type annotation: %v\n", err)
		os.Exit(1)
	}

	fmt.Println(type_)
}

func printHelp() {
	fmt.Println(`
Convert json to Go type annotations.

Usage:
	echo '{"json": "here"}' | json2go
	echo '{"json": "here"}' | json2go -type=MyTypeName
	json2go -type=MyTypeName '{"json": "here"}'`[1:])
}
